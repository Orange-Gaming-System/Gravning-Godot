class_name TileManager extends TileMapLayer

enum TileBits {
    TL  = 0x01,
    TM  = 0x02,
    TR  = 0x04,
    CL  = 0x08,
    CR  = 0x10,
    BL  = 0x20,
    BM  = 0x40,
    BR  = 0x08
}

const tile_index: PackedByteArray = [
    0x33,0x33,0x23,0x23,0x33,0x33,0x23,0x23,0x32,0x32,0x37,0x22,0x32,0x32,0x37,0x22,
    0x30,0x30,0x34,0x34,0x30,0x30,0x20,0x20,0x31,0x31,0x38,0x35,0x31,0x31,0x36,0x21,
    0x33,0x33,0x23,0x23,0x33,0x33,0x23,0x23,0x32,0x32,0x37,0x22,0x32,0x32,0x37,0x22,
    0x30,0x30,0x34,0x34,0x30,0x30,0x20,0x20,0x31,0x31,0x38,0x35,0x31,0x31,0x36,0x21,
    0x03,0x03,0x13,0x13,0x03,0x03,0x13,0x13,0x07,0x07,0x47,0x17,0x07,0x07,0x47,0x17,
    0x04,0x04,0x44,0x44,0x04,0x04,0x14,0x14,0x08,0x08,0x48,0x3a,0x08,0x08,0x39,0x18,
    0x03,0x03,0x13,0x13,0x03,0x03,0x13,0x13,0x02,0x02,0x27,0x12,0x02,0x02,0x27,0x12,
    0x04,0x04,0x44,0x44,0x04,0x04,0x14,0x14,0x05,0x05,0x2a,0x45,0x05,0x05,0x19,0x15,
    0x33,0x33,0x23,0x23,0x33,0x33,0x23,0x23,0x32,0x32,0x37,0x22,0x32,0x32,0x37,0x22,
    0x30,0x30,0x34,0x34,0x30,0x30,0x20,0x20,0x31,0x31,0x38,0x35,0x31,0x31,0x36,0x21,
    0x33,0x33,0x23,0x23,0x33,0x33,0x23,0x23,0x32,0x32,0x37,0x22,0x32,0x32,0x37,0x22,
    0x30,0x30,0x34,0x34,0x30,0x30,0x20,0x20,0x31,0x31,0x38,0x35,0x31,0x31,0x36,0x21,
    0x03,0x03,0x13,0x13,0x03,0x03,0x13,0x13,0x07,0x07,0x47,0x17,0x07,0x07,0x47,0x17,
    0x00,0x00,0x24,0x24,0x00,0x00,0x10,0x10,0x06,0x06,0x29,0x09,0x06,0x06,0x46,0x16,
    0x03,0x03,0x13,0x13,0x03,0x03,0x13,0x13,0x02,0x02,0x27,0x12,0x02,0x02,0x27,0x12,
    0x00,0x00,0x24,0x24,0x00,0x00,0x10,0x10,0x01,0x01,0x28,0x25,0x01,0x01,0x26,0x11
]

## Converts a tile index to an atlas coordinate. Tile indexes are in hexadecimal: #yx.
static func index_to_tile(index: int) -> Vector2i:
    return Vector2i(index & 15, index >> 4)

## Converts an atlas coordinate to a tile index. Tile indexs are in hexadecimal: #yx.
static func tile_to_index(tile: Vector2i):
    return tile.x + (tile.y << 4)

## Get the atlas coordinates given a neighbor match bitmask
static func neighbors_to_tile(neighbors : int) -> Vector2i:
    return index_to_tile(tile_index[neighbors])

## Converts an atlas coordinate to the proper format for [member tile_index].
static func format_tile(tile: Vector2i):
    var index = tile_to_index(tile)
    return "0x" + ("%x" % index).lpad(2, "0")

func get_tile_row(pos: Vector2i):
    var x = 0
    var row = []
    while x < 16:
        row.append(format_tile(get_cell_atlas_coords(pos + Vector2i(x*4, 0))))
        x += 1
    var output = ",".join(row)
    return output.indent("    ")

func get_tiles():
    var y = 0
    while y < 16:
        print(get_tile_row(Vector2i(0, 30 + (y * 4))))
        y += 1

func _ready():
    get_tiles()
